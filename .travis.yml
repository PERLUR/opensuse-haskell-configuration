# .travis.yml

dist: bionic
language: c

cache:
  directories:
    - $HOME/.cabal/packages
    - $HOME/.cabal/store
    - $HOME/build/opensuse-haskell/configuration/_build

before_cache:
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/build-reports.log
  # remove files that are regenerated by 'cabal update'
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/00-index.*
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/*.json
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.cache
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar.idx

before_install:
  - unset CC
  - sudo add-apt-repository ppa:hvr/ghc -y
  - sudo apt-get update -q
  - sudo apt-get install cabal-install-3.0 ghc-8.8.1 rpm -y
  - export PATH="$HOME/.cabal/bin:/opt/ghc/bin:/opt/cabal/bin:$PATH"

install:
  - python3 --version
  - cabal --version
  - echo "$(ghc --version) [$(ghc --print-project-git-commit-id 2> /dev/null || echo '?')]"
  - travis_retry cabal new-update
  - "sed -i 's/^jobs:.*/jobs: 2/' $HOME/.cabal/config"
  - cabal new-install shelltestrunner

script:
  - rm -f _build/*/*/*.changes
  - cabal new-run cabal2obs -- --keep-going -j2 ghc-8.6.x ghc-8.8.x ghc-8.10.x
  - cabal new-test all
  - tests/run-tests
